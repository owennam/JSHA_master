rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: 사용자가 로그인했는지 확인
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: 본인의 문서인지 확인
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ============================================
    // 기존 users 컬렉션 (인솔 회원)
    // ============================================
    match /users/{userId} {
      // 본인의 프로필은 읽을 수 있음
      allow read: if isOwner(userId);

      // 회원가입 시 본인 UID로 새 프로필 생성 가능
      allow create: if isOwner(userId);

      // 본인의 프로필 업데이트 가능 (단, status 필드는 변경 불가)
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']);

      // 주문 하위 컬렉션
      match /orders/{orderId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // 다시보기 등록자 컬렉션 (recapRegistrants)
    // ============================================
    match /recapRegistrants/{userId} {
      // 본인의 등록 정보는 읽을 수 있음
      allow read: if isOwner(userId);

      // 회원가입 시 본인 UID로 새 등록 정보 생성 가능
      allow create: if isOwner(userId);

      // 본인의 등록 정보 업데이트 가능 (단, status/accessLevel은 변경 불가)
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'accessLevel']);
    }

    // ============================================
    // 다시보기 비디오 컬렉션 (recapVideos)
    // ============================================
    match /recapVideos/{videoId} {
      // 승인된 사용자만 읽기 가능 (accessLevel 기반 필터링은 클라이언트에서 처리)
      allow read: if isSignedIn();
      // 쓰기는 서버(Admin SDK)에서만 가능
      allow write: if false;
    }

    // 기타 모든 문서는 기본적으로 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
