rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: 사용자가 로그인했는지 확인
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: 본인의 문서인지 확인
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function: 관리자 권한 확인 (특정 UID 또는 이메일)
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.email in [
          'admin@jsha.com',
          // 관리자 이메일을 여기에 추가하세요
        ]
      );
    }

    // ============================================
    // 기존 users 컬렉션 (인솔 회원)
    // ============================================
    match /users/{userId} {
      // 본인의 프로필은 읽을 수 있음
      allow read: if isOwner(userId);

      // 회원가입 시 새 프로필 생성 가능
      allow create: if isSignedIn() && isOwner(userId);

      // 본인의 프로필 업데이트 가능 (단, status 필드는 제외)
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']);

      // 관리자는 모든 사용자 조회 및 status 업데이트 가능
      allow read, update: if isAdmin();

      // 주문 하위 컬렉션
      match /orders/{orderId} {
        allow read, write: if isOwner(userId);
        allow read, write: if isAdmin();
      }
    }

    // ============================================
    // 다시보기 등록자 컬렉션 (recapRegistrants)
    // ============================================
    match /recapRegistrants/{userId} {
      // 본인의 등록 정보는 읽을 수 있음
      allow read: if isOwner(userId);

      // 회원가입 시 새 등록 정보 생성 가능
      allow create: if isSignedIn() && isOwner(userId);

      // 본인의 등록 정보 업데이트 가능 (단, status와 accessLevel 필드는 관리자만 변경 가능)
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'accessLevel']);

      // ⚠️ 개발 환경: 모든 접근 허용 (프로덕션에서는 isAdmin()으로 변경 필요)
      allow read, write: if true;
    }

    // ============================================
    // 다시보기 비디오 컬렉션 (recapVideos)
    // ============================================
    match /recapVideos/{videoId} {
      // ⚠️ 개발 환경: 모든 접근 허용 (프로덕션에서는 isAdmin()으로 변경 필요)
      // 프로덕션 환경에서는 다음과 같이 설정 권장:
      // - 읽기: 승인된 사용자만 (accessLevel 기반 필터링은 클라이언트에서 처리)
      // - 쓰기: 관리자만
      allow read, write: if true;
    }

    // 기타 모든 문서는 기본적으로 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
