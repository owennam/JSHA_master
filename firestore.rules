rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: 사용자가 로그인했는지 확인
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: 본인의 문서인지 확인
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function: 관리자인지 확인
    function isAdmin() {
      return isSignedIn() && request.auth.uid == 'Fvupff2KAzLqbRwJO8ThFr28omE3';
    }

    // ============================================
    // 기존 users 컬렉션 (인솔 회원)
    // ============================================
    match /users/{userId} {
      // 본인의 프로필은 읽을 수 있음
      allow read: if isOwner(userId);

      // 회원가입 시 본인 UID로 새 프로필 생성 가능
      allow create: if isOwner(userId);

      // 본인의 프로필 업데이트 가능 (단, status 필드는 변경 불가)
      allow update: if isOwner(userId) &&
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status']);

      // 주문 하위 컬렉션
      match /orders/{orderId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // 다시보기 등록자 컬렉션 (recapRegistrants)
    // ============================================
    match /recapRegistrants/{userId} {
      // 로그인된 사용자는 모든 등록 정보 읽기 가능 (관리자 기능용)
      allow read: if isSignedIn();

      // 회원가입 시 본인 UID로 새 등록 정보 생성 가능
      allow create: if isOwner(userId);

      // 로그인된 사용자는 수정 가능 (관리자 승인 기능용)
      allow update: if isSignedIn();

      // 시청 기록 서브컬렉션
      match /watchedVideos/{videoId} {
        // 본인만 읽기/쓰기 가능
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // 다시보기 비디오 컬렉션 (recapVideos)
    // ============================================
    match /recapVideos/{videoId} {
      // 읽기는 누구나 가능 (보안: isPublished 필터링 + 클라이언트 accessLevel 체크)
      allow read: if true;
      // 쓰기는 서버 Admin SDK만 가능 (서버 API 통해서만 수정)
      allow write: if false;
    }

    // ============================================
    // 교과서 등록 컬렉션 (bookRegistrations)
    // ============================================
    match /bookRegistrations/{registrationId} {
      // 로그인된 사용자는 생성 가능
      allow create: if isSignedIn();
      // 읽기는 로그인된 사용자만 가능
      allow read: if isSignedIn();
    }

    // 기타 모든 문서는 기본적으로 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
